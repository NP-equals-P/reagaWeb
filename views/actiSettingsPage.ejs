<!DOCTYPE html>
<html lang="en">
    <head>

        <script>

            var components;
    
            async function onLoadFunction() {
                components = await getComponents();
    
                pageStart()
            }
    
            async function getComponents() {
                const url = "http://localhost:3000/components?reacId=" + document.getElementById("reacId").value;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }
    
                    const json = await response.json();
                    return json;
                } catch (error) {
                    console.error(error.message);
                }
            }
    
            async function pageStart() {
                var actionType = document.getElementById("actionType").value;
                
                if (actionType === "sensor") {
                    document.getElementById("sensorRadio").checked = true
                } else {
                    document.getElementById("actuatorRadio").checked = true
                }
    
                await changeType();
                await changeModel();
                await changeFunction();
            }
    
            async function changeType() {
                var componentSelect = document.getElementById("componentSelect");
                var dataComponent = document.getElementById("currentComponent").value;
                var str = "";
                var aux;
    
                if (document.getElementById("sensorRadio").checked) {
                    for (let i=0; i<components.sensors.length; i+=1) {
    
                        if (dataComponent === components.sensors[i]._id.toString()) {
                            aux = "selected";
                        } else {
                            aux = "";
                        }
    
                        str += "<option value=" + components.sensors[i]._id + " " + aux + ">" + components.sensors[i].name + "</option>"
                        componentSelect.innerHTML = str;
                    }
                } else {
                    for (let i=0; i<components.actuators.length; i+=1) {
    
                        if (dataComponent === components.actuators[i]._id.toString()) {
                            aux = "selected";
                        } else {
                            aux = "";
                        }
    
                        str += "<option value=" + components.actuators[i]._id + " " + aux + ">" + components.actuators[i].name + "</option>"
                        componentSelect.innerHTML = str;
                    }
                }
    
                await changeModel();
                await changeFunction();
            }
    
            async function getModelFunctions() {
                var type;
    
                if (document.getElementById("sensorRadio").checked) {
                    type = "sensor";
                } else {
                    type = "actuator";
                }
    
                const url = "http://localhost:3000/modelFunctions?compId=" + document.getElementById("componentSelect").value + "&type=" + type;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }
    
                    const json = await response.json();
                    return json;
                } catch (error) {
                    console.error(error.message);
                }
            }
    
            async function changeModel() {
                var functions = await getModelFunctions();
                var functionSelect = document.getElementById("functionSelect");
                var dataFunction = document.getElementById("currentFunction").value;
                var str = "";
                var aux;
    
                for (let i=0; i<functions.length; i+=1) {
                    if (dataFunction.toString() && (dataFunction.toString() === functions[i]._id.toString())) {
                        aux = "selected";
                    } else {
                        aux = "";
                    }
    
                    str += "<option value=" + functions[i]._id + " " + aux + ">" + functions[i].name + "</option>"
                    functionSelect.innerHTML = str;
                }
    
                await changeFunction();
            }
    
            async function getFunctionHTML() {
                var functionId = document.getElementById("functionSelect").value;
    
                const url = "http://localhost:3000/functionHTML?funcId=" + document.getElementById("functionSelect").value;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Response status: ${response.status}`);
                    }
    
                    const json = await response.json();
                    return json;
                } catch (error) {
                    console.error(error.message);
                }
            }
    
            async function changeFunction() {
                var funcHTMLStr = await getFunctionHTML();
    
                document.getElementById("varDiv").innerHTML = funcHTMLStr.html;
            }
    
        </script>

        <link rel="stylesheet" href="/styles/actiSettingsStyle.css">
        <link rel="icon" href="./pictures/logo.ico" type="image/x-icon">
        <title> Add Action </title>
    </head>

    <body>
        <input type="hidden" id="actionType" name="actionType" value=<%= action.type %>>
        <%- include('./partials/nav.ejs', {name: user.username, _id: user._id}) %>
        <div class="div1">

                <a href="/api/event/editEvent?_id=<%= user._id + "&reacId=" + reacId + "&routId=" + routId + "&evntId=" + evntId %>">
                    <button class="backButt" name="type" value="saveBack">Back</button>
                </a>

                <label for="" class="nameLabel">Name</label>
                <input type="text" name="newActiName" id="newActiName" class="nameInput" value="<%= action.name %>">

                <label for="" class="sensorLabel">Sensor</label>
                <input type="radio" name="group" id="sensorRadio" value="sensor" class="sensorRadio" onclick="changeType()">
                <label for="" class="actuatorLabel">Actuator</label>
                <input type="radio" name="group" id="actuatorRadio" value="actuator" class="actuatorRadio" onclick="changeType()">

                <label for="" class="componentLabel">Chosen component:</label>

                <select name="newComponent" id="componentSelect" class="componentSelect" onchange="changeModel()"></select>

                <label for="" class="functionLabel">Function</label>
                <select name="newFunction" id="functionSelect" class="functionSelect" onchange="changeFunction()"></select>

                <label for="" class="startLabel">Starts</label>
                <input type="number" name="newStart" id="" class="startInput" value="<%=action.start%>">

                <label for="" class="endLabel">Ends</label>
                <input type="number" name="newEnd" id="" class="endInput" value="<%=action.end%>">

                <input type="hidden" id="currentComponent" value=<%= action.component %>>
                <input type="hidden" id="currentFunction" value=<%= action.function %>>

                <input type="hidden" id="actiId" name="actiId" value=<%= action._id %>>
                <input type="hidden" id="routId" name="routId" value=<%= routId %>>
                <input type="hidden" id="evntId" name="evntId" value=<%= evntId %>>
                <input type="hidden" id="reacId" name="reacId" value=<%= reacId %>>
                <input type="hidden" id="_id" name="_id" value=<%= user._id %>>

                <div class="div2" id="varDiv">
                </div>
        
                <% if (action.isCreation) { %>
                    <form action="/api/action/createAction" method="post">
                        <button class="confirmButt">Create Event</button>
                        <input type="hidden" name="_id" value=<%= user._id %>>
                        <input type="hidden" name="reacId" value=<%= reacId %>>
                        <input type="hidden" name="routId" value=<%= routId %>>
                        <input type="hidden" name="evntId" value=<%= evntId %>>
                        <input type="hidden" name="actiId" value=<%= action._id %>>
                    </form>
                    <form action="/api/action/dicardActionEdit" method="post">
                        <button class="discardButt">Discard Edit</button>
                        <input type="hidden" name="_id" value=<%= user._id %>>
                        <input type="hidden" name="reacId" value=<%= reacId %>>
                        <input type="hidden" name="routId" value=<%= routId %>>
                        <input type="hidden" name="evntId" value=<%= evntId %>>
                        <input type="hidden" name="actiId" value=<%= action._id %>>
                    </form>
                <% } else { %>
                    <form action="/api/action/deleteAction" method="post">
                        <button class="deleteButt">Delete Event</button>
                        <input type="hidden" name="_id" value=<%= user._id %>>
                        <input type="hidden" name="reacId" value=<%= reacId %>>
                        <input type="hidden" name="routId" value=<%= routId %>>
                        <input type="hidden" name="evntId" value=<%= evntId %>>
                        <input type="hidden" name="actiId" value=<%= action._id %>>
                    </form>
                <% } %>

        </div>
    </body>
</html>